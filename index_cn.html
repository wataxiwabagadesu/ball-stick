<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Ball-Stick 分子生成器（CN离线友好 + 移动端优化）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />

  <!-- 本地 Kekule 样式 -->
  <link rel="stylesheet" href="./vendor/kekule/kekule.css" />

  <style>
    :root { --bg:#f7f7f9; --card:#fff; --line:rgba(0,0,0,.10); --muted:#666; --btn:#f6f7ff; --btnb:#cfd8ff; --r:14px; --tap:44px; }
    html, body { margin:0; height:100%; font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei",sans-serif; background:var(--bg); }
    body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; overscroll-behavior:none; }

    header { position: sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid var(--line); padding:10px 12px; }
    .title { font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .title small { font-weight:600; color:var(--muted); font-size:12px; }

    input, button, select {
      height: var(--tap); padding:0 12px; border-radius:12px; border:1px solid rgba(0,0,0,.18);
      font-size:15px; background:#fff; box-sizing:border-box; outline:none;
    }
    button { cursor:pointer; background:var(--btn); border-color:var(--btnb); font-weight:700; }
    button:active { transform: translateY(1px); }

    #status { font-size:12px; color:#333; line-height:1.35; margin-top:8px; }

    #main { height: calc(100% - 10px); display:grid; grid-template-columns:1fr; gap:10px; padding:10px; box-sizing:border-box; }
    .panel { background:var(--card); border:1px solid var(--line); border-radius:var(--r); overflow:hidden; display:flex; flex-direction:column; min-height:340px; min-height: min(520px, 60vh); }
    .panel h3 { margin:0; padding:10px 12px; font-size:14px; background:rgba(0,0,0,.02); border-bottom:1px solid rgba(0,0,0,.06); }
    .panel .body { flex:1; min-height:0; position:relative; }
    #composer, #viewer3d { width:100%; height:100%; }

    /* 让 3D 触摸不被页面滚动抢走 */
    #viewer3d { touch-action: none; }

    .tips { padding:10px 12px; font-size:12px; color:var(--muted); border-top:1px solid rgba(0,0,0,.06); background:#fff; }

    .controls { display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px; }
    .line { display:grid; grid-template-columns:1fr; gap:8px; }

    @media (min-width: 860px) {
      #main { grid-template-columns:1.1fr 0.9fr; }
      .line { grid-template-columns: 1.3fr 0.8fr 0.8fr; align-items:center; }
      .panel { min-height: calc(100vh - 190px); }
    }

    #toast {
      position: fixed; left:50%; bottom: calc(16px + env(safe-area-inset-bottom));
      transform: translateX(-50%); padding:10px 14px; border-radius:999px;
      background: rgba(0,0,0,.75); color:#fff; font-size:12px; opacity:0;
      pointer-events:none; transition: opacity .25s ease; z-index:50; max-width:min(92vw,520px); text-align:center;
    }
    #toast.show { opacity:1; }
    code { background:rgba(0,0,0,.06); padding:2px 6px; border-radius:8px; }
  </style>

  <!-- 本地 three + 本地 Kekule（bundle 单文件版） -->
  <script src="./vendor/three/three.min.js"></script>
  <script src="./vendor/kekule/kekule.min.js"></script>

  <script>
    // 同源 OpenBabel / worker（你仓库 assets/kekule/extra 下的四个文件）
    const extraPath = new URL('./assets/kekule/extra/', document.baseURI).toString();
    Kekule.environment.setEnvVar('openbabel.path', extraPath);
  </script>
</head>

<body>
<header>
  <div class="title">
    Ball-Stick 分子生成器 <small>CN 离线友好 / Mobile Touch 优化</small>
  </div>

  <div class="controls">
    <div class="line">
      <input id="inpSmiles" placeholder="输入 SMILES（推荐，如 CCO / c1ccccc1）" />
      <button id="btnLoadSmiles">SMILES → 2D</button>
      <button id="btnGen3D">生成 3D</button>
    </div>

    <div class="line" style="grid-template-columns:1fr 1fr; gap:8px;">
      <button id="btnClear">清空</button>
      <select id="displayMode" title="3D显示风格">
        <option value="BALL_STICK" selected>球棍</option>
        <option value="STICKS">棍状</option>
        <option value="WIRE">线框</option>
        <option value="SPACE_FILL">空间填充</option>
      </select>
    </div>

    <div id="status">状态：初始化中…</div>
  </div>
</header>

<div id="main">
  <div class="panel">
    <h3>二维结构编辑器（可画 / 可改）</h3>
    <div class="body" id="composer"></div>
    <div class="tips">移动端建议横屏；导入 SMILES 后生成 3D 最稳定。</div>
  </div>

  <div class="panel">
    <h3>三维球棍模型（触摸优化：单指旋转 / 双指缩放）</h3>
    <div class="body" id="viewer3d"></div>
    <div class="tips">右侧 3D 区域已开启 <code>touch-action:none</code>，避免被页面滚动抢手势。</div>
  </div>
</div>

<div id="toast"></div>

<script>
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const toastEl = $("toast");

  const safeCall = (obj, fn, ...args) => (obj && typeof obj[fn] === "function") ? obj[fn](...args) : undefined;
  const setStatus = (msg) => { statusEl.textContent = msg; console.log("[STATUS]", msg); };
  const toast = (msg, ms=1600) => { toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), ms); };

  let composerWidget = null;
  let viewerWidget = null;

  function pickMol(obj) {
    if (!obj) return null;
    if (obj instanceof Kekule.StructureFragment) return obj;
    if (obj instanceof Kekule.Molecule) return obj;
    if (typeof obj.getChildCount === "function" && typeof obj.getChildAt === "function") {
      for (let i=0;i<obj.getChildCount();i++) { const f = pickMol(obj.getChildAt(i)); if (f) return f; }
    }
    if (typeof obj.getChildren === "function") {
      for (const c of (obj.getChildren() || [])) { const f = pickMol(c); if (f) return f; }
    }
    return null;
  }

  function initWidgets() {
    composerWidget = new Kekule.Editor.Composer($("composer"));
    safeCall(composerWidget, "setEnableToolbar", true);
    safeCall(composerWidget, "setToolbarDisplayed", true);
    safeCall(composerWidget, "setToolbarVisible", true);

    viewerWidget = new Kekule.ChemWidget.Viewer3D($("viewer3d"));
    safeCall(viewerWidget, "setEnableToolbar", true);
    safeCall(viewerWidget, "setToolbarDisplayed", true);
    safeCall(viewerWidget, "setToolbarVisible", true);

    applyDisplayMode();
  }

  function applyDisplayMode() {
    if (!viewerWidget) return;
    const T = Kekule?.Render?.Molecule3DDisplayType;
    if (!T) return;
    const map = { BALL_STICK: T.BALL_STICK, STICKS: T.STICKS, WIRE: T.WIRE, SPACE_FILL: T.SPACE_FILL };
    safeCall(viewerWidget, "setMoleculeDisplayType", map[$("displayMode").value] || T.BALL_STICK);
    safeCall(viewerWidget, "refresh");
  }

  function ensureOpenBabel() {
    return new Promise((resolve, reject) => {
      if (Kekule.OpenBabel && Kekule.OpenBabel.isAvailable && Kekule.OpenBabel.isAvailable()) return resolve();
      setStatus("状态：正在加载 OpenBabel（本地 wasm + worker）…");
      let done = false;
      const timer = setTimeout(() => { if (!done) { done = true; reject(new Error("OpenBabel 加载超时：检查 assets/kekule/extra 是否可访问")); } }, 12000);
      Kekule.OpenBabel.enable((err) => {
        if (done) return;
        clearTimeout(timer); done = true;
        if (err) reject(err); else resolve();
      });
    });
  }

  async function loadSmilesTo2D() {
    const smiles = $("inpSmiles").value.trim();
    if (!smiles) return toast("先输入 SMILES");
    await ensureOpenBabel();

    setStatus("状态：导入 SMILES 并生成 2D…");
    const mol = Kekule.IO.loadFormatData(smiles, "smi");

    const gen2d = new Kekule.Calculator.ObStructure2DGenerator();
    gen2d.setSourceMol(mol);
    await new Promise((res, rej) => gen2d.execute(e => e ? rej(e) : res()));

    const out = safeCall(gen2d, "getGeneratedMol") || mol;
    safeCall(composerWidget, "setChemObj", out);
    setStatus("状态：2D 已生成（可编辑）");
    toast("2D 已生成");
  }

  async function gen3D() {
    await ensureOpenBabel();
    const mol = pickMol(safeCall(composerWidget, "getChemObj"));
    if (!mol) return toast("请先画结构或导入 SMILES");

    setStatus("状态：生成 3D 坐标…");
    const gen3d = new Kekule.Calculator.ObStructure3DGenerator();
    gen3d.setSourceMol(mol);
    await new Promise((res, rej) => gen3d.execute(e => e ? rej(e) : res()));

    const mol3D = safeCall(gen3d, "getGeneratedMol") || mol;
    safeCall(viewerWidget, "setChemObj", mol3D);
    safeCall(viewerWidget, "zoomToFit");
    setStatus("状态：3D 生成完成");
    toast("3D 已生成");
  }

  function clearAll() {
    safeCall(composerWidget, "setChemObj", null);
    safeCall(viewerWidget, "setChemObj", null);
    $("inpSmiles").value = "";
    setStatus("状态：已清空");
    toast("已清空");
  }

  $("btnLoadSmiles").onclick = () => loadSmilesTo2D().catch(e => (console.error(e), alert(e.message || e)));
  $("btnGen3D").onclick = () => gen3D().catch(e => (console.error(e), alert(e.message || e)));
  $("btnClear").onclick = clearAll;
  $("displayMode").onchange = applyDisplayMode;

  Kekule.X.domReady(() => {
    initWidgets();
    setStatus("状态：就绪（输入 SMILES，例如 CCO）");
    toast("就绪");
  });
</script>

</body>
</html>
