<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Ball-Stick 分子生成器（2D → 3D）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Kekule 样式 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/kekule/dist/themes/default/kekule.css" />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei";
    }
    header {
      padding: 10px 14px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    header b { margin-right: 8px; }

    input, button, select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button { cursor: pointer; }

    #status {
      font-size: 12px;
      color: #555;
    }

    #main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: calc(100% - 62px);
    }

    .panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
    }
    .panel:last-child { border-right: none; }

    .panel h3 {
      margin: 0;
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    .panel .body {
      flex: 1;
      min-height: 0;
    }

    #composer, #viewer3d {
      width: 100%;
      height: 100%;
    }

    .subbar {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 8px;
      align-items: center;
    }
  </style>

  <!-- three.js（Kekule 3D 依赖） -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <!-- Kekule（含 openbabel + worker 支持） -->
  <script src="https://cdn.jsdelivr.net/npm/kekule/dist/kekule.js
    ?modules=io,chemWidget,calculation,openbabel
    &locals=en,zh
    &language=zh"></script>

  <!-- ★★★ 关键修复：指定 worker / openbabel 同源路径 ★★★ -->
  <script>
    const extraPath = new URL('./assets/kekule/extra/', document.baseURI).toString();
    Kekule.environment.setEnvVar('openbabel.path', extraPath);
  </script>
</head>

<body>

<header>
  <b>Ball-Stick 分子生成器</b>

  <input id="inpFormula" placeholder="化学式，如 C2H6O" />
  <button id="btnSearchFormula">查候选</button>

  <select id="selHits" disabled>
    <option>（等待化学式搜索）</option>
  </select>
  <button id="btnLoadHit" disabled>加载 → 2D</button>

  <input id="inpSmiles" placeholder="或直接输入 SMILES" style="min-width:260px"/>
  <button id="btnLoadSmiles">SMILES → 2D</button>

  <button id="btnGen3D">生成 3D</button>

  <span id="status">未加载 OpenBabel</span>
</header>

<div id="main">
  <div class="panel">
    <h3>二维结构编辑器</h3>
    <div class="body">
      <div id="composer"
           data-widget="Kekule.Editor.Composer"
           data-enable-toolbar="true"
           data-auto-size="true"
           data-padding="20"></div>
    </div>
  </div>

  <div class="panel">
    <h3>三维球棍模型</h3>
    <div class="body">
      <div id="viewer3d"
           data-widget="Kekule.ChemWidget.Viewer3D"
           data-auto-size="true"
           data-padding="20"></div>
    </div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const statusEl = $("status");

  function composer() {
    return Kekule.Widget.getWidgetById("composer");
  }
  function viewer() {
    return Kekule.Widget.getWidgetById("viewer3d");
  }

  // 启用 OpenBabel（wasm + worker）
  function ensureOpenBabel() {
    return new Promise((resolve, reject) => {
      if (Kekule.OpenBabel.isAvailable()) {
        statusEl.textContent = "OpenBabel 已就绪";
        resolve();
        return;
      }
      statusEl.textContent = "正在加载 OpenBabel…";
      Kekule.OpenBabel.enable(err => {
        if (err) reject(err);
        else {
          statusEl.textContent = "OpenBabel 已就绪";
          resolve();
        }
      });
    });
  }

  // SMILES → 2D
  async function loadSmiles(smiles) {
    await ensureOpenBabel();
    const mol = Kekule.IO.loadFormatData(smiles, "smi");

    const gen2d = new Kekule.Calculator.ObStructure2DGenerator();
    gen2d.setSourceMol(mol);
    await new Promise((res, rej) => gen2d.execute(e => e ? rej(e) : res()));

    composer().setChemObj(gen2d.getGeneratedMol());
  }

  // 2D → 3D
  async function gen3D() {
    await ensureOpenBabel();
    const mol = composer().getChemObj();
    if (!mol) {
      alert("请先画或导入二维结构");
      return;
    }

    const gen3d = new Kekule.Calculator.ObStructure3DGenerator();
    gen3d.setSourceMol(mol);
    await new Promise((res, rej) => gen3d.execute(e => e ? rej(e) : res()));

    viewer().setChemObj(gen3d.getGeneratedMol());
    viewer().zoomToFit();
  }

  // 化学式 → PubChem CID → SMILES
  async function searchFormula(formula) {
    statusEl.textContent = "正在查询 PubChem…";
    const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/formula/${encodeURIComponent(formula)}/property/CanonicalSMILES,IUPACName/JSON`;
    const j = await fetch(url).then(r => r.json());
    const list = j?.PropertyTable?.Properties || [];

    $("selHits").innerHTML = "";
    list.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.CanonicalSMILES;
      opt.textContent = `${p.IUPACName || "(无名)"} | ${p.CanonicalSMILES}`;
      $("selHits").appendChild(opt);
    });

    $("selHits").disabled = false;
    $("btnLoadHit").disabled = false;
    statusEl.textContent = `找到 ${list.length} 个候选`;
  }

  // 绑定按钮
  $("btnSearchFormula").onclick = () =>
    searchFormula($("inpFormula").value);

  $("btnLoadHit").onclick = () =>
    loadSmiles($("selHits").value);

  $("btnLoadSmiles").onclick = () =>
    loadSmiles($("inpSmiles").value);

  $("btnGen3D").onclick = gen3D;

  Kekule.X.domReady(() => {
    viewer().setMoleculeDisplayType(
      Kekule.Render.Molecule3DDisplayType.BALL_STICK
    );
  });
</script>

</body>
</html>
